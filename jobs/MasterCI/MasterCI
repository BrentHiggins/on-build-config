node{
    deleteDir()
    checkout scm
    def shareMethod = load("jobs/ShareMethod.groovy")
    try{
        stage("Create Manifest"){
            load("jobs/create_manifest/create_manifest.groovy")
        }
        def manifest_name=env.MANIFEST_FILE_URL.tokenize('/')[-1];
        currentBuild.description = "<a href=${env.MANIFEST_FILE_URL}>${manifest_name}</a>";
 
        shareMethod.downloadManifest(env.MANIFEST_FILE_URL, manifest_name)

        stash name: "masterci_manifest", includes: "${manifest_name}"
        env.stash_manifest_name = "masterci_manifest"
        env.stash_manifest_path = "${manifest_name}"
       
        stage("Unit Test"){
            def unit_test = load("jobs/UnitTest/UnitTest.groovy")
            unit_test.runTest("masterci_manifest", manifest_name, pwd())
        }
        stage("Function Test"){
            load("jobs/function_test/function_test.groovy")
        }

        shareMethod.buildAndPublish()
    } finally{
        shareMethod.sendResult(true, true)
    }
}
